#!/usr/bin/env python

#This is the file to make my first shake
#a proof of concept with only protein and water

import rospy
import time
from std_msgs.msg import String
from shakestation.msg import JointPose
from robotis_controller_msgs.msg import StatusMsg
from servosix import ServoSix

def manipulator_status_callback(data):
	rospy.loginfo(rospy.get_caller_id() + "I heard %s", data.status_msg)
	if data.status_msg == "End Trajectory":
		MANIPULATOR_MOVING = False
	return	

def move_manipulator(joints):
	msg = JointPose()
	msg.name = ["joint1", "joint2", "joint3", "joint4", "joint5", "joint6"]
	msg.value = [joints[0], joints[1], joints[2], joints[3], joints[4], joints[5]]
	MANIPULATOR_MOVING = True
	pub.publish(msg)
	while (time.time() < (time.time() + 10)):
		if not MANIPULATOR_MOVING:
			break
		time.sleep(.1)

def build_shake():

	#open gripper
	ss= ServoSix()
	ss.set_servo(1,10)
	time.sleep(1) 

	#move the manipulator to the initial position
	move_manipulator([0.0, -0.6579891280018623, 0.05009094953223726, 0.0, 0.6085963101704226, 0.0])
	print("moved to start position 1")

	#move the manipulator to the initial cup position
	msg1 = JointPose()
	msg1.name = ["joint1", "joint2", "joint3", "joint4", "joint5", "joint6"]
	msg1.value = [-0.7819075048934596, 0.9948376736367678, 0.43493604959698695, -0.2617993877991494, -1.53588974175501, -0.00890117918517108]
	time.sleep(4) 
	pub.publish(msg1)
	print("moved to approach cup postion 2")

	#move the manipulator to the grasp cup position
	msg2 = JointPose()
	msg2.name = ["joint1", "joint2", "joint3", "joint4", "joint5", "joint6"]
	msg2.value = [-0.7819075048934596, 0.9948376736367678, 0.43493604959698695, 0.0, -1.53588974175501, -0.00890117918517108]
	time.sleep(4) 
	pub.publish(msg2)
	print("moved to grasp cup postion 3")

	#grasp cup
	t_end = time.time() + 15
	while time.time() < t_end:
		ss.set_servo(1,30)
	time.sleep(2) 
	
	print("grasped cup")

	#move the manipulator to the initial cup position
	msg3 = JointPose()
	msg3.name = ["joint1", "joint2", "joint3", "joint4", "joint5", "joint6"]
	msg3.value = [-0.7819075048934596, 0.9948376736367678, 0.43493604959698695, -0.2617993877991494, -1.53588974175501, -0.00890117918517108]
	time.sleep(4) 
	pub.publish(msg3)
	print("moved to approach cup postion 4")

	#move the manipulator to the initial position
	msg4 = JointPose()
	msg4.name = ["joint1", "joint2", "joint3", "joint4", "joint5", "joint6"]
	msg4.value = [0.0, -0.6579891280018623, 0.05009094953223726, 0.0, 0.6085963101704226, 0.0]
	time.sleep(4) 
	pub.publish(msg4)
	print("return to start position 5")

if __name__=='__main__':
	try:
		#create the ROS node for the application	
		rospy.init_node('shakemaker')

		#setup publisher to send manipulator joint commands, allow 2 seconds for publisher to register
		pub = rospy.Publisher('/robotis/base/joint_pose_msg',JointPose, queue_size=1)
		time.sleep(2) 

		#setup a subscriber to recieve notifications about manipulator status, allow 2 seconds for subscriber to register
		rospy.Subscriber("/robotis/status", StatusMsg, manipulator_status_callback)
		time.sleep(2) 

		#run the main application
		build_shake()
	except rospy.ROSInterruptException:
		pass
